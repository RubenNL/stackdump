{% extends 'base.html' %}

{% block title %}Stackdump search for "{{ query }}"{% endblock %}

{% block body %}
    <div class="row">
        <div class="span16">
            <form id="search" method="get" action="{{ SETTINGS.APP_URL_ROOT }}search">
                <input type="text" class="xlarge" name="q" value="{{ query }}" />
                <input type="hidden" name="s" value="{{ sort_by }}" />
                <input type="submit" class="btn primary" value="Search" />
            </form>
            
            <ul class="tabs">
                <li {% if sort_by == 'newest' %}class="active"{% endif %}><a href="{{ REQUEST.url|set_get_parameters('s=newest', 'p=0') }}">newest</a></li>
                <li {% if sort_by == 'votes' %}class="active"{% endif %}><a href="{{ REQUEST.url|set_get_parameters('s=votes', 'p=0') }}">votes</a></li>
                <li {% if sort_by == 'relevance' %}class="active"{% endif %}><a href="{{ REQUEST.url|set_get_parameters('s=relevance', 'p=0') }}">relevance</a></li>
            </ul>
        </div>
    </div>
    <div class="row">
        <div class="span12">
            <ul id="search-results">
                {% for r in results %}
                <li>
                    <div class="post-stats-vertical">
                        <div class="post-stat">
                            <p class="post-stat-value {% if r.question.score < 0 %}post-stat-value-poor{% endif %}">
                                {{ r.question.score }}
                            </p>
                            <p>vote{% if r.question.score != 1 %}s{% endif %}</p>
                        </div>
                        <div class="post-stat">
                            <p class="post-stat-value {% if r.answers|length == 0 %}post-stat-value-poor{% endif %}">
                                {{ r.answers|length }}
                            </p>
                            <p>answer{% if r.answers|length != 1 %}s{% endif %}</p>
                        </div>
                    </div>
                    <div class="post-summary">
                        <h3><a href="#">{{ r.question.title }}</a></h3>
                        <p>{{ r.question.body|striptags|truncate(256) }}</p>
                        <p class="post-details">
                            Asked by <strong>{{ r.question.ownerUser.displayName }}</strong> on
                            <strong>{{ r.question.creationDate|format_datetime }}</strong>.
                        </p>
                        <div class="post-tags">
                            {% for t in r.question.tags %}
                            <span class="label">{{ t }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {# hack to force a clear on all internal elements #}
                    <div class="clearfix"></div>
                </li>
                {% endfor %}
            </ul>
            <div class="pagination">
                <ul>
                    {% if current_page > 1 %}
                    {# the prev page is current_page - 2 because current_page is ones-based, but the p GET parameter is zero-based #}
                    <li class="prev"><a href="{{ REQUEST.url|set_get_parameters('p=' ~ (current_page - 2)) }}">&larr; Previous</a></li>
                    {% else %}
                    <li class="prev disabled"><a href="#">&larr; Previous</a></li>
                    {% endif %}
                    {% for p in range(1, total_pages + 1) %}
                    <li {% if p == current_page %}class="active"{% endif %}><a href="{{ REQUEST.url|set_get_parameters('p=' ~ (p-1)) }}">{{ p }}</a></li>
                {% endfor %}
                {% if current_page != total_pages %}
                {# the next page is just current_page because current_page is ones-based, but the p GET parameter is zero-based #}
                <li class="next"><a href="{{ REQUEST.url|set_get_parameters('p=' ~ current_page) }}">&rarr; Next</a></li>
                {% else %}
                <li class="next disabled"><a href="#">&rarr; Next</a></li>
                {% endif %}
                </ul>
            </div>
        </div>
        <div class="span4">
            <div class="total-hits">
                <p>
                    <span class="stat-value">{{ total_hits }}</span>
                </p>
                <p>
                    posts matched your query <em>"{{ query }}"</em>.
                </p>
            </div>
            
            <div class="well site-list-container">
                <h3>Narrow by site</h3>
                <ul class="site-list">
                    {% for s in sites %}
                    <li>
                        <img src="{{ SETTINGS.APP_URL_ROOT }}media/logos/{{ s.key }}.png" alt="{{ s.name }} logo" />
                        <h6>
                            <a href="{{ SETTINGS.APP_URL_ROOT }}{{ s.key }}/search?q={{ query }}">{{ s.name }}</a>
                            <small class="tagline">{{ s.dump_date }}</small>
                        </h6>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
{% endblock %}